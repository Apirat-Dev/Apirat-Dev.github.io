<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GitHub Restaurants Editor (Auto Merge)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-light">
  <div class="container py-5">
    <div class="card shadow-sm p-4">
      <h1 class="h3 mb-3 text-center text-primary">Restaurants Editor</h1>
      <!-- <p class="text-muted">หน้าเว็บนี้จะโหลดไฟล์ <code>config/restaurants.json</code> จาก repo <strong>Apirat-Dev/Apirat-Dev.github.io</strong> และให้คุณเพิ่มชื่อร้านใหม่ จากนั้นสามารถอัปเดตไฟล์โดยอัตโนมัติรวมถึง Merge ทันที</p> -->

      <div class="mb-3">
        <a id="backToMain" class="btn btn-outline-primary btn-sm" href="random.html">Home</a>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-md-8">
          <input id="newName" class="form-control" placeholder="Enter new restaurant name then, click Add" />
        </div>
        <div class="col-md-4 d-grid">
          <button id="addBtn" class="btn btn-success">Add</button>
        </div>
      </div>

      <div class="alert alert-secondary" id="status">Status: Ready</div>

      <div class="mb-3">
        <button id="reloadBtn" class="btn btn-outline-primary btn-sm">Load data</button>
        <!-- <button id="proposeBtn" class="btn btn-primary btn-sm ms-2">สร้าง Pull Request (ใช้ token ของฉัน)</button> -->
        <button id="autoMergeBtn" class="btn btn-primary btn-sm ms-2">Commit</button>
      </div>

      <h5 class="mt-3">Restaurant List</h5>
      <ul id="list" class="list-group mb-3" style="min-height:120px"></ul>

      <h6 class="mt-3">Preview JSON</h6>
      <div class="mb-3">
  <button class="btn btn-outline-secondary btn-sm" type="button"
          data-bs-toggle="collapse" data-bs-target="#previewContainer"
          aria-expanded="false" aria-controls="previewContainer">
    Show / Hide JSON Raw
  </button>

  <div class="collapse mt-2" id="previewContainer">
    <pre id="preview" class="bg-dark text-light p-3 rounded" style="min-height:120px;">[]</pre>
  </div>
</div>
    </div>
  </div>

  <script>
    const OWNER = 'Apirat-Dev';
    const REPO = 'Apirat-Dev.github.io';
    const PATH = 'config/restaurants.json';
    const RAW_URL = `https://raw.githubusercontent.com/${OWNER}/${REPO}/main/${PATH}`;

    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const previewEl = document.getElementById('preview');

    function setStatus(text, type='info') {
      // อัปเดต div เดิม (backup)
      statusEl.className = 'alert alert-' + type;
      statusEl.textContent = 'Status: ' + text;

      // Popup ด้วย SweetAlert2
      const iconMap = {
        info: 'info',
        success: 'success',
        warning: 'warning',
        danger: 'error',
        secondary: 'question'
      };
      Swal.fire({
        title: 'System Status',
        text: text,
        icon: iconMap[type] || 'info',
        timer: 3000,
        showConfirmButton: false,
        toast: true,
        position: 'top-end',
      });
    }


    let restaurants = [];

    // Encrypt Decrypt functions ===========================================================================================================================
    // แปลง string → ArrayBuffer
    function encode(str) {
      return new TextEncoder().encode(str);
    }

    // แปลง ArrayBuffer → string
    function decode(buf) {
      return new TextDecoder().decode(buf);
    }

    // แปลง ArrayBuffer → Base64
    function bufToBase64(buf) {
      let binary = '';
      new Uint8Array(buf).forEach(b => binary += String.fromCharCode(b));
      return btoa(binary);
    }

    // แปลง Base64 → ArrayBuffer
    function base64ToBuf(b64) {
      return Uint8Array.from(atob(b64), c=>c.charCodeAt(0)).buffer;
    }

    // สร้าง key จาก passphrase
    async function getKey(passphrase) {
      const enc = encode(passphrase);
      const hash = await crypto.subtle.digest('SHA-256', enc);
      return crypto.subtle.importKey('raw', hash, 'AES-GCM', false, ['encrypt','decrypt']);
    }

    // Encrypt string → Base64
    async function encryptText(text, passphrase) {
      const key = await getKey(passphrase);
      const iv = crypto.getRandomValues(new Uint8Array(12)); // AES-GCM IV 12 bytes
      const encrypted = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, encode(text));
      // เก็บ iv+encrypted เป็น Base64
      const combined = new Uint8Array(iv.byteLength + encrypted.byteLength);
      combined.set(iv, 0);
      combined.set(new Uint8Array(encrypted), iv.byteLength);
      return bufToBase64(combined.buffer);
    }

    // Decrypt Base64 → string
    async function decryptText(b64, passphrase) {
      const buf = base64ToBuf(b64);
      const iv = buf.slice(0, 12);
      const data = buf.slice(12);
      const key = await getKey(passphrase);
      const decrypted = await crypto.subtle.decrypt({name:'AES-GCM', iv: new Uint8Array(iv)}, key, data);
      return decode(decrypted);
    }
    //==============================================================================================================================================================
    function renderList(){
      listEl.innerHTML = '';
      restaurants.forEach((r,i)=>{
        const li = document.createElement('li');
        li.className = 'list-group-item d-flex justify-content-between align-items-center';
        li.textContent = r;
        const btn = document.createElement('button');
        btn.className = 'btn btn-sm btn-outline-danger';
        btn.textContent = 'Remove';
        btn.onclick = ()=>{ restaurants.splice(i,1); renderList(); updatePreview(); };
        li.appendChild(btn);
        listEl.appendChild(li);
      });
      if(restaurants.length===0){
        const li = document.createElement('li'); li.className='list-group-item text-muted'; li.textContent='(Do not have any data)'; listEl.appendChild(li);
      }
    }

    function updatePreview(){ previewEl.textContent = JSON.stringify(restaurants, null, 2); }

    async function loadFromGit(){
      try{
        setStatus('Fetching data from GitHub...', 'info');
        const res = await fetch(RAW_URL);
        if(!res.ok) throw new Error('Cannot load file from GitHub: ' + res.status);
        const json = await res.json();
        if(!Array.isArray(json)) throw new Error('File format is not Array');
        restaurants = json.slice();
        renderList(); updatePreview();
        setStatus('Data loaded', 'success');
      }catch(err){ console.error(err); setStatus('Error: ' + err.message, 'danger'); }
    }

    document.getElementById('reloadBtn').addEventListener('click', ()=> loadFromGit());

    document.getElementById('addBtn').addEventListener('click', ()=>{
      const name = document.getElementById('newName').value.trim();
      if(!name) return alert('Please enter a restaurant name');
      restaurants.push(name);
      document.getElementById('newName').value = '';
      renderList(); updatePreview();
    });

    async function promptForToken(){
      return prompt('โปรดวาง GitHub Personal Access Token ของคุณ (scopes: repo)');
    }

    async function ghFetch(path, token, opts={}) {
      const headers = opts.headers || {};
      headers['Accept'] = 'application/vnd.github+json';
      headers['Authorization'] = 'token ' + token;
      const res = await fetch('https://api.github.com' + path, {...opts, headers});

      if (!res.ok) {
        const txt = await res.text();
        throw new Error('GitHub API error ' + res.status + ': ' + txt);
      }

      // ถ้า response ไม่มี body หรือ status 204 → return null
      const text = await res.text();
      if (!text) return null;
      try {
        return JSON.parse(text);
      } catch (e) {
        console.warn('Response not JSON:', text);
        return text; // คืนค่าเป็น string แทน
      }
    }

    async function createBranch(owner, repo, newBranchName, token){
      const repoInfo = await ghFetch(`/repos/${owner}/${repo}`, token);
      const defaultBranch = repoInfo.default_branch;
      const ref = await ghFetch(`/repos/${owner}/${repo}/git/refs/heads/${defaultBranch}`, token);
      const sha = ref.object.sha;
      await ghFetch(`/repos/${owner}/${repo}/git/refs`, token, { method: 'POST', body: JSON.stringify({ref: 'refs/heads/' + newBranchName, sha}) });
      return {newBranchName, defaultBranch};
    }

    async function putFile(owner, repo, path, contentStr, commitMessage, branch, token){
      let sha;
      try{
        const fileInfo = await ghFetch(`/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}?ref=${branch}`, token);
        sha = fileInfo.sha;
      }catch(e){ }
      const body = { message: commitMessage || 'Update restaurants.json via web form', content: btoa(unescape(encodeURIComponent(contentStr))), branch };
      if(sha) body.sha = sha;
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${encodeURIComponent(path)}`, {
        method: 'PUT', headers: {'Authorization':'token '+token,'Accept':'application/vnd.github+json','Content-Type':'application/json'}, body: JSON.stringify(body)
      });
      if(!res.ok){ const txt = await res.text(); throw new Error('Failed to PUT file: ' + res.status + ' ' + txt); }
      return res.json();
    }

    async function createPullRequest(owner, repo, headBranch, baseBranch, title, bodyText, token){
      return ghFetch(`/repos/${owner}/${repo}/pulls`, token, { method: 'POST', body: JSON.stringify({title, head: headBranch, base: baseBranch, body: bodyText}) });
    }

    async function mergePullRequest(owner, repo, pullNumber, token){
      return ghFetch(`/repos/${owner}/${repo}/pulls/${pullNumber}/merge`, token, { method: 'PUT', body: JSON.stringify({merge_method: 'merge'}) });
    }

    async function deleteBranch(owner, repo, branch, token){
      return ghFetch(`/repos/${owner}/${repo}/git/refs/heads/${branch}`, token, { method: 'DELETE' });
    }

    // New Auto Merge button
    document.getElementById('autoMergeBtn').addEventListener('click', async ()=>{
      try{
        if(restaurants.length===0) return alert('ไม่มีข้อมูลที่จะอัปเดต');
        setStatus('Requesting token...', 'info');
        // const token = await promptForToken();
        const encryptedToken = 'YbJGQBbS4J9U1xkvQCdqXuWQLR/jfJpdgSCs2Z8p5UQM5fH1RGbBbSGRs7NWN6VknN5OeijH8RhXI0WjE4HPHnTJ1nYKw7uMiNd01Vq3gce79srnBksVdXys9BY544MoHg6g+kifPUUayNfnW7pFFDotKZ4dhvgqhA==';
        const passphrase = 'apirat';
        const token = await decryptText(encryptedToken, passphrase);

        if(!token){ setStatus('Cancel: Do not have token', 'warning'); return; }
        
        const ts = Date.now().toString(36);
        const branchName = 'auto-merge-restaurants-' + ts;
        const {defaultBranch} = await createBranch(OWNER, REPO, branchName, token);
        setStatus('Committing file to branch: ' + branchName, 'info');
        const contentStr = JSON.stringify(restaurants, null, 2);
        await putFile(OWNER, REPO, PATH, contentStr, 'Update restaurants.json via Auto Merge', branchName, token);
        setStatus('Creating Pull Request...', 'info');
        const pr = await createPullRequest(OWNER, REPO, branchName, defaultBranch, 'Auto Merge restaurants.json', 'Update by web form', token);
        setStatus('Merging PR automatically...', 'info');
        await mergePullRequest(OWNER, REPO, pr.number, token);
        setStatus('Merge Complete! Deleting temporary branch...', 'info');
        await deleteBranch(OWNER, REPO, branchName, token);
        setStatus('Success — Data updated on main', 'success');
      }catch(err){ console.error(err); setStatus('Error: ' + err.message, 'danger'); }
    });

    // Initial load
    loadFromGit();
  </script>
</body>
</html>